\section{Modelado}
% Se define la entrada del sistema como la se˜nal de comando u al servomotor. Indique cu´al es la se˜nal de
% comando que utilizar´a para comandar el mismo (sea la real, o sea virtual a conveniencia), cu´ales son los
% valores l´ımites, y cu´al es el concepto f´ısico relacionado a dicho valor.
% Se define la salida como la posici´on del carro p, obtenido del sensor de distancia. Indique c´omo se
% representa dicho valor en el sistema, en qu´e direcci´on est´a definido, cu´ales son los valores l´ımites que considera.
% Se define otra variable como el ´angulo de la barra θ, la cual puede considerarse una variable de estado
% del sistema. Indique c´omo se representa dicho valor en el sistema, en qu´e direcci´on est´a definido, cu´ales son
% los valores l´ımites que considera.
% Obtener una representaci´on en variables de estado, y una transferencia entrada-salida del sistema, lin-
% ealizado en torno al punto donde la barra est´a perfectamente horizontal, y el carro o bola se encuentra en el
% centro de dicha barra, que se denominar´a el punto de equilibrio. El modelo del sistema puede obtenerse de
% cualquier manera conveniente. Puede utilizarse un modelo matem´atico donde se midan de manera directa
% los valores de las variables (pesos, largos, momentos de inercia). Tambi´en un modelo mixto donde se iden-
% tifiquen de manera pr´actica algunos par´ametros o transferencias del sistema. Es posible tambi´en utilizar un
% modelado tipo caja negra. Sin embargo, deben recordarse y tenerse en cuenta las ventajas y sobre todo las
% desventajas de cada uno.

El sistema a modelar se muestra en la Figura~\ref{fig:planta}. Consiste de un servomotor que mueve una barra a través de un brazo. Sobre la barra se coloca un carrito que se desliza libremente. Además, cuenta con una IMU que es capaz de medir el ángulo de la barra, y con un sensor de distancia que mide la posición del carrito a lo largo de la barra.

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=\linewidth]{img/planta.jpg}
    \caption{Sistema \emph{ball-and-beam} a analizar durante el trabajo.}
    \label{fig:planta}
\end{figure}

\subsection{Entrada del sistema}

Para realizar el control de la planta, se define como entrada de la misma el comando $u$ enviado al servomotor, en grados. Se mide positivamente ángulos antihorarios. El comando real del servomotor se realiza a través de la duración de un pulso PWM, donde un valor de \qty{1500}{\us} se corresponde con un \emph{setpoint} de \qty{0}{\degree} respecto de la horizontal. El ángulo comandado al servomotor se mueve linealmente entre \qty{-90}{\degree} para una entrada temporal de \qty{500}{\us}, y \qty{90}{\degree} para \qty{2500}{\us}. Dado que existe una sencilla relación afín entre el tiempo y el ángulo comandado, es válido utilizar el ángulo comandado como entrada virtual dada su mayor interpretabilidad.

Como el ángulo comandado al servomotor se traduce a través del brazo hacia la barra en forma no lineal, solo es conveniente mover el servomotor una cantidad limitada de grados para mantener al sistema alrededor de un punto donde haya una relación aproximadamente lineal entre el ángulo del servo y el de la barra. Por ello, se decidió limitar la entrada al sistema en el rango \qtyrange{-30}{30}{\degree}.

\subsection{Salida del sistema}

Como salida del sistema se considera a la posición $p$ del carro. La misma mide la posición en metros del centro geométrico del carrito, respecto del centro de la barra. La dirección positiva es la que se aleja del sensor de distancia.

Los valores límites de la posición son \qty{-0.152}{\m} y \qty{0.172}{\m}. El extremo inferior se corresponde con la posición más negativa que puede tomar el carrito y aún ser detectado por el sensor de distancia, que es incapaz de medir distancias muy pequeñas. El extremo superior se corresponde con el carro justo en el otro extremo de la barra.

\subsection{Ángulo de la barra}

Otra variable de interés para el modelado del sistema es el ángulo de la barra $\theta$, medido en grados respecto de la horizontal. Este ángulo se mide positivamente en sentido antihorario, tal como el ángulo comandado al servo. Asumiendo la relación linealizada entre estos dos ángulos, donde en estado estacionario $\theta \approx 0.39 u$, los límites de $\theta$ estarán dados por el rango de \qtyrange{-11.7}{11.7}{\degree}.

\subsection{Representación en variables de estado}

El sistema se representará en variables de estado alrededor del punto de equilibrio conformado por la barra en posición horizontal y el carro perfectamente centrado, tal como muestra la Figura~\ref{fig:planta}. Se considera al sistema como la concatenación de dos subsistemas: el sistema servo-barra cuya entrada es el comando al servo $u$ y su salida es el ángulo de la barra $\theta$; y el sistema conformado por el carro, cuya entrada es el ángulo de la barra y su salida es la posición del carro $y = p$.

Entonces, podemos escribir la transferencia completa del sistema como
\[
    \frac{Y(s)}{U(s)} = \frac{\Theta(s)}{U(s)} \frac{Y(s)}{\Theta(s)},
\]
donde la primera transferencia del lado derecho representa la dinámica del sistema servo-barra, y la segunda representa la dinámica del carro en función del ángulo de la barra.

\subsubsection{Sistema servo-barra}

Para obtener la transferencia $\Theta(s) / U(s)$, primero se notó que el sistema consiste de una parte mecánica de un grado de libertad que puede representarse por un sistema de segundo orden, y luego una parte eléctrica dentro del servomotor que es difícil de representar pero tiene una dinámica muy rápida. Por lo tanto, se decidió representar a la transferencia como un sistema de segundo orden con dos polos y ningún cero, quedando de la siguiente forma:
\[
    \frac{\Theta(s)}{U(s)} = \frac{K}{(s+p_1)(s+p_2)}.
\]

Se realizó una identificación del sistema a una frecuencia de \qty{50}{\Hz}, introduciendo como comando al servo escalones simétricos de diferentes amplitudes en grados, y midiendo el ángulo de la barra. El sistema discreto a identificar tiene la forma:
\[
    \frac{\Theta(z)}{U(z)} = \frac{\gamma}{1 - \alpha z^{-1} - \beta z^{-2}}.
\]

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=\linewidth]{img/ident-barra.eps}
    \caption{Señales comandada y medida, y salida del sistema servo-barra identificado.}
    \label{fig:ident-barra}
\end{figure}

La Figura~\ref{fig:ident-barra} muestra la señal comandada al servomotor, y el ángulo medido de la barra. Además, se muestra la salida del sistema identificado por regresión lineal. Se observa una buena concordancia entre la salida del sistema real y el identificado. Como resultado de la identificación del sistema se encontró que
\begin{align*}
    \alpha = 1.61 && \beta = -0.652 && \gamma = 0.0174.
\end{align*}
De aquí se pueden despejar los polos discretos, los cuales resultan en
\begin{align*}
    p_{1,2}^{(d)} = 0.804 \pm 0.0775j,
\end{align*}
y utilizando la relación entre polos discretos y continuos dada por
\[
    p^{(d)} = e^{p T_s},
\]
con $T_s = 1/f_s = \qty{20}{\ms}$, se llega a que los polos del sistema servo-barra son
\begin{align*}
    p_{1,2} = -10.7 \pm 4.81j.
\end{align*}
El sistema entonces es ligeramente oscilante, con una frecuencia de oscilación $w_d = \qty{4.81}{\radian\per\s}$ (aproximadamente \qty{0.8}{\Hz}) y un coeficiente de amortiguamiento $\zeta = 0.91$ (casi críticamente amortiguado). Su transferencia es
\begin{align}
    \label{eq:tf-servo-barra}
    \frac{\Theta(s)}{U(s)} = \frac{53.64}{s^2 + 21.4 s + 137.6}
    = \frac{0.39}{\left(\frac{s}{11.73}\right)^2 + 2 \frac{0.91 s}{11.73} + 1}.
\end{align}

A partir de la transferencia hallada, puede encontrarse una representación en variables de estado para este subsistema. Dado que se trata de un sistema de segundo orden, se tendrán dos variables de estado, las cuales se eligen como el ángulo de la barra $\theta$ y su velocidad angular $\omega$. La entrada al sistema es el comando $u$ al servo, y la salida es el ángulo de la barra.

Despejando de la Ecuación~\eqref{eq:tf-servo-barra}, se tiene
\begin{align*}
    \Theta s^2 + 21.4 \Theta s + 137.6 \Theta = 53.64 U.
\end{align*}
Antitransformando, la ecuación diferencial queda
\begin{align*}
    \ddot{\theta} + 21.4 \dot{\theta} + 137.6 \theta = 53.64 u,
\end{align*}
de donde se puede despejar
\begin{align*}
    \ddot{\theta} &= -137.6 \theta - 21.4 \dot{\theta} + 53.64 u,
\end{align*}
o equivalentemente,
\begin{align*}
    \dot{\omega} &= -137.6 \theta - 21.4 \omega + 53.64 u.
\end{align*}

Entonces, la representación en espacio de estados de este subsistema es
\begin{align*}
    \begin{bmatrix} \dot{\theta} \\ \dot{\omega} \end{bmatrix} =
        \begin{bmatrix} 0 & 1 \\ -137.6 & -21.4 \end{bmatrix} \begin{bmatrix} \theta \\ \omega \end{bmatrix}
        + \begin{bmatrix} 0 \\ 53.64 \end{bmatrix} u.
\end{align*}

\subsubsection{Sistema barra-carrito}

Para obtener la transferencia entre el ángulo de la barra y la posición del carrito $Y(s) / \Theta(s)$, se considera que el sistema linealizado alrededor del equilibrio (barra horizontal y carro centrado) tiene un polo en cero, y otro polo estable cuya posición depende del momento de inercia de las ruedas, la masa del carro, y la fricción viscosa del sistema. Por lo tanto, en forma simplificada tenemos
\[
    \frac{Y(s)}{\Theta(s)} = \frac{A}{s(s+p)}.
\]
El sistema discreto equivalente, obtenido por aproximación \emph{backwards} con $s = (z-1)/(z T_s)$, tendrá un polo en $z = 1$ proveniente del integrador en el sistema continuo, y otro polo a determinar, es decir,
\[
    \frac{Y(z)}{\Theta(z)} = \frac{A T_s^2 z^2}{(z - 1)(z (1 + p T_s) - 1)} = \frac{A T_s^2 z^2 p^{(d)}}{(z-1)(z-p^{(d)})},
\]
donde $p^{(d)} = 1/(1 + p T_s)$.

Para realizar el reconocimiento del polo faltante, se aplicaron entradas tipo escalón de amplitudes $\pm \qty{25}{\degree}$ a la entrada del sistema a lazo abierto, midiendo el ángulo de la barra y la posición del carrito resultantes. Cada experimento (ángulo positivo y ángulo negativo) se repitió cinco veces, promediando los reultados y ajustando por prueba y error los parámetros $k$ y $p$ de forma tal de que se consiga un buen ajuste de los datos experimentales por parte del sistema discreto. Como resultado, se obtuvo un par de valores para $k$ y un par de valores para $p$, que mejor ajustan el comportamiento de la planta para ángulos positivos y negativos. Se tomó el promedio de cada experimento para obtener así los siguientes valores
\begin{align*}
    k = -0.15 && p = \qty{1.75}{\radian\per\s}.
\end{align*}
de donde la transferencia resulta
\begin{align}
    \label{eq:tf-barra-carro}
    \frac{Y(s)}{\Theta(s)} = \frac{-0.15}{s(s+1.75)}.
\end{align}

Las Figuras~\ref{fig:ident-carro} y~\ref{fig:ident-carro2} muestran el ángulo medido de la barra, la posición medida del carrito, y la salida del sistema ajustado manualmente, para ambas excursiones del ángulo. Se observa que incluso después de promediar las asimetrías, la concordancia entre el sistema ajustado y el real es bastante aceptable.

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=\linewidth]{img/ident-carrito.eps}
    \caption{Señales utilizadas para la identificación del sistema barra-carrito, para un ángulo positivo, y salida del sistema ajustado.}
    \label{fig:ident-carro}
\end{figure}

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=\linewidth]{img/ident-carrito2.eps}
    \caption{Señales utilizadas para la identificación del sistema barra-carrito, para un ángulo negativo, y salida del sistema ajustado.}
    \label{fig:ident-carro2}
\end{figure}

A partir de la transferencia hallada, puede encontrarse una representación en variables de estado para este subsistema. Dado que se trata de un sistema de segundo orden, se tendrán dos variables de estado, las cuales se eligen como la posición del carrito $p$ y su velocidad $v$. La entrada al sistema es el ángulo de la barra $\theta$, y la salida es la posición del carro $y = p$.

Despejando de la Ecuación~\eqref{eq:tf-barra-carro}, se tiene
\begin{align*}
    Ys^{2} + 1.75 Y s = -0.15 \Theta
\end{align*}
Antitransformando, la ecuación diferencial queda
\begin{align*}
    \ddot{y} + 1.75 \dot{y} = -0.15 \theta
\end{align*}
de donde se puede despejar
\begin{align*}
    \ddot{y} = -1.75 \dot{y} - 0.15 \theta,
\end{align*}
o equivalentemente,
\begin{align*}
    \dot{v} &= -1.75 v - 0.15 \theta.
\end{align*}

Entonces, la representación en espacio de estados de este subsistema es
\begin{align*}
    \begin{bmatrix} \dot{p} \\ \dot{v} \end{bmatrix} =
        \begin{bmatrix} 0 & 1 \\ 0 & -1.75 \end{bmatrix} \begin{bmatrix} p \\ v \end{bmatrix}
        + \begin{bmatrix} 0 \\ - 0.15 \end{bmatrix} \theta.
\end{align*}

\subsubsection{Sistema completo}

A partir de la concatenación de los sistemas anteriormente analizados, se puede encontrar la representación en espacio de estados del sistema completo. Este sistema tendrá como entrada el comando $u$ al servomotor, y su salida será la posición $y = p$ del carrito.

Las ecuaciones diferenciales que describen al sistema completo son
\begin{align*}
    \dot{\theta} &= \omega, \\
    \dot{\omega} &= -137.6 \theta - 21.4 \omega + 53.64 u, \\
    \dot{p} &= v, \\
    \dot{v} &= -1.75 v - 0.15 \theta.
\end{align*}
Por lo tanto, una representación en espacio de estados del sistema completo será
\begin{align*}
    \begin{bmatrix} \dot{\theta} \\ \dot{\omega} \\ \dot{p} \\ \dot{v} \end{bmatrix} =
        \underbrace{\begin{bmatrix}
            0 & 1 & 0 & 0 \\
            -137.6 & -21.4 & 0 & 0\\
            0 & 0 & 0 & 1 \\
            -0.15 & 0 & 0 & -1.75
        \end{bmatrix}}_{A} \begin{bmatrix} \theta \\ \omega \\ p \\ v \end{bmatrix}
            + \underbrace{\begin{bmatrix} 0 \\ 53.64 \\ 0 \\ 0 \end{bmatrix}}_{B} u,
\end{align*}
donde la salida es
\begin{align*}
    y = \underbrace{\begin{bmatrix} 0 & 0 & 1 & 0 \end{bmatrix}}_{C} \begin{bmatrix} \theta \\ \omega \\p \\ v \end{bmatrix} + \underbrace{0}_{D} u.
\end{align*}

La transferencia total del sistema será el producto de las transferencias individuales, resultando en
\begin{align}
    \label{tf:planta}
    \frac{Y(s)}{U(s)} = \frac{Y(s)}{\Theta(s)} \frac{\Theta(s)}{U(s)}
        = \frac{53.64}{s^2 + 21.4 s + 137.6} \frac{-0.15}{s(s+1.75)}
        = \frac{-8.046}{s (s+1.75) (s^2 + 21.4 s + 137.6)}.
\end{align}

A modo de verificación final, se realizó una comparación entre la respuesta a un escalón de amplitud \qty{-25}{\degree} de la planta real completa, y la transferencia obtenida en la Ecuación~\eqref{tf:planta}. La Figura~\ref{fig:step-planta} muestra los resultados obtenidos. Se observa una muy buena concordancia entre la transferencia obtenida y la planta real, por lo que se concluye que se tiene una buena modelación de la planta.

\begin{figure}[!htbp]
    \centering
    \includegraphics[width=\linewidth]{img/step-planta.eps}
    \caption{Respuesta al escalón de la planta real completa y la transferencia del modelo. Notar que las posiciones se escalaron a centímetros.}
    \label{fig:step-planta}
\end{figure}

% vim: ts=4 sts=4 sw=4 et lbr
